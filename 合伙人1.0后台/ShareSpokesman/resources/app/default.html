<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="user-scalable=no,width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <!-- <meta http-equiv="Cache-control" content="no-cache" /> -->
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title></title>
    <!-- Bootstrap -->
    <link href="static/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="static/animate.css" rel="stylesheet">
    <style type="text/css">
    .simulation-body { position: fixed; top: 0; right: 0; bottom: 0; left: 0; background-color: rgba(255, 255, 255, 1); z-index: 999; }
    .simulation-body .simulation-method { position: absolute; top: 20px; right: 20px; bottom: 50%; left: 20px; }
    .simulation-body .simulation-content { position: absolute; top: 50%; right: 0; bottom: 0; left: 0; padding: 10px; overflow-y: scroll; background-color: #f5f5f5; }
    .simulation-body .simulation-content .title::before{ content: ''; padding-top: 2px; padding-bottom: 2px; padding-left: 2px; padding-right: 2px; background-color: #388a3e; margin-right: 8px; }
    .simulation-body .simulation-content pre{ border: none; background-color: none; margin-left: 10px; margin-top: 10px; }

    .timed-task { position: fixed; top: 0; right: 0; bottom: 0; left: 0; background-color: rgba(255, 255, 255, 1); z-index: 999; }
    .timed-task .timed-task-header{ padding: 15px 20px; font-size: 12px;  }
    .timed-task .timed-task-content{ padding: 0 20px 20px 20px; }
    </style>
</head>

<body>
    <!-- <center> <h2>分享代言, 开发服务端</h2> </center> -->
    <div class="container-fluid" style="width: 90%; margin-top: 20px;">
        <table class="table table-bordered">
            <caption>Windows右下角, 系统图标 '经汉科技' 右键可以打开控制器, 重启等操作</caption>
            <tr>
                <th>服务类型</th>
                <th>服务地址</th>
                <th>服务端口</th>
                <th width="130">调试</th>
                <th width="130">定时任务</th>
            </tr>
            <tr>
                <td>Http</td>
                <td>localhost</td>
                <td>8081</td>
                <td align="center"><a href="javascript:;" style=" color: red; " @click=" simulation.type = 'get' "> POST / GET </a></td>
                <td align="center"><a href="javascript:;" @click=" _timedTask "> 管理任务 </a></td>
            </tr>
        </table>
    </div>
    <div class="container-fluid" style="width: 96%; margin-top: 10px;">
        <table class="table table-bordered">
            <caption> 点击 Url 查看 headers </caption>
            <tr>
                <th>API - Url</th>
                <th width="100">Method</th>
                <th width="100">Status</th>
                <th width="175">Datetime</th>
            </tr>
            <tr v-for=" item in open_call.api ">
                <td><div style="width:500px; word-wrap:break-word;"><a href="javascript:;" v-html=" item.url || '---' " @click=" _headers(item) "></a></div></td>
                <td v-html=" item.method || '---' "></td>
                <td v-html=" item.status || '---' "></td>
                <td v-html=" item.datetime || '---' "></td>
            </tr>
        </table>
    </div>
    <div class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Request Headers</h4>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered table-striped">
                        <tr>
                            <th width="250">Name</th>
                            <th>Value</th>
                        </tr>
                        <tr v-for=" ( name, value ) in modal.header ">
                            <td v-html=" name || '---' "></td>
                            <td v-html=" value || '---' "></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="simulation-body" v-show=" simulation.type.length " :data-length=" simulation.type.length ">
        <div class="simulation-method method-post">
            <form class="form-horizontal">
                <div class="form-group">
                    <label class="col-xs-2 control-label">路径</label>
                    <div class="col-xs-4">
                        <input type="text" class="form-control" v-model=" simulation.path " placeholder="test/get">
                    </div>
                    <div class="col-xs-2">
                        <div class="radio"> <label> <input type="radio" v-model=" simulation.type " value="get"> GET </label> </div>
                    </div>
                    <div class="col-xs-2">
                        <div class="radio"> <label> <input type="radio" v-model=" simulation.type " value="post"> POST </label> </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-xs-2 control-label">Get Params</label>
                    <div class="col-xs-6">
                        <input type="text" class="form-control" v-model=" simulation.get_param " placeholder="a=1&b=2">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-xs-2 control-label">Post Params</label>
                    <div class="col-xs-8">
                        <textarea class="form-control" rows="6" :disabled=" simulation.type == 'get' " v-model=" simulation.post_param | textareaCode "placeholder="参数内容为 JSON 格式"></textarea>
                    </div>
                </div>
                <div class="form-group">
                </div>
                <div class="form-group">
                    <div class="col-xs-offset-2 col-xs-4">
                        <button type="button" class="btn btn-default" @click=" _simulationSubmit "> Submit </button>
                        <button type="button" class="btn btn-default" @click=" simulation.type = '' "> Close </button>
                    </div>
                    <div class="col-xs-4"><input type="text" class="form-control" v-model=" simulation.get_href " placeholder="http://...:80/"></div>
                </div>
            </form>
        </div>
        <div class="simulation-content">
            <div class="title">Request URL</div>
            <pre v-show=" simulation.request_url " v-html=" simulation.request_url "></pre>
            <pre v-else> --- </pre>
            <div class="title">Response Headers</div>
            <pre v-show=" simulation.headers " v-html=" simulation.headers "></pre>
            <pre v-else> --- </pre>
            <div class="title">Response Database</div>
            <pre v-show=" simulation.content " v-html=" simulation.content | code "></pre>
            <pre v-else> --- </pre>
        </div>
    </div>
    <div class="timed-task" v-show=" timed_task.show ">
        <div class="timed-task-header">
            定时每 <span class="text-primary">50000毫秒循环1次</span>, 每循环 4次 重新获取任务表,  <span class="text-danger">修改,创建定时任务直接到数据库操作!!! 数据表: <strong>db_daily_execution</strong> </span>
            <span class="pull-right"><a href="javascript:;" @click=" _timedTaskReset ">重新获取任务表</a> / <a href="javascript:;" @click=" timed_task.show = false ">返回</a></span>
        </div>
        <div class="timed-task-content">
            <table class="table table-bordered">
                <tr>
                    <th>Request Url</th>
                    <th>执行方式</th>
                    <th @click=" _timedTask ">最后执行时间</th>
                </tr>
                <tr v-for=" task in timed_task.list ">
                    <td v-html=" task.implement_url || '---' "></td>
                    <td>
                        <span v-if=" task.types == 0">每 <strong v-html=" task.run_date | 0 "></strong> 分钟</span>
                        <span v-if=" task.types == 1">每 <strong v-html=" task.run_date | 0 "></strong> 小时</span>
                        <span v-if=" task.types == 2">每天 <strong v-html=" task.run_date || '--' "></strong></span>
                        <span v-if=" task.types == 3">每月 <strong v-html=" task.run_date || '--' "></strong> 号</span>
                    </td>
                    <td v-html=" task.trigger_date || '---' "></td>
                </tr>
            </table>
        </div>
    </div>
    <script type="text/javascript" src="static/jquery/jquery.2.1.4.js"></script>
    <script src="static/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="static/vue.min.js"></script>
    <script type="text/javascript">
    $(function() {
        const TimedTask = require('./lib/timedTask.js');
        TimedTask.config( require('./lib/core.js') );
        new Vue({
            el: 'body',
            data: {
                open_call: open_call || {},
                modal: {},
                simulation: {
                    request_url: '',
                    get_href: 'http://localhost:8081/',
                    type: '',
                    path: '',
                    get_param: '',
                    post_param: { "name1": "POST 参数1", "name2": "POST 参数2", "name3": "POST 参数3" },
                    headers: '',
                    content: '',
                },
                timed_task: {
                    show: false,
                    list: [],
                    editor: {}
                }
            },
            filters: {
                code(obj) {
                    return JSON.stringify(obj, null, 4);
                },
                textareaCode(str) {
                    try{
                        if( !str ){ return ''; }
                        if( 'string' === typeof str ){
                            str = JSON.parse( str.replace("\n",'') );
                        }
                        return JSON.stringify( str , null, 4);
                    } catch(e){ }
                    return str
                }
            },
            watch: {},
            computed: {},
            methods: {
                _headers(item) {
                    this.modal = item;
                    $('.modal').modal('show');
                },
                _simulation(type) {
                    this.simulation.type = type;
                },
                _simulationSubmit() {
                    var config = {};
                    config.url = this.simulation.get_href + this.simulation.path;
                    config.dataType = 'json';
                    config.type = 'get';
                    if( this.simulation.get_param ){
                        config.url += '?'+ this.simulation.get_param;
                    }
                    if( this.simulation.type == 'post' ){
                        config.type = 'post';
                        console.log( this.simulation.post_param )
                        if( this.simulation.post_param ){
                            try{
                                if( 'string' === typeof this.simulation.post_param ){
                                    config.data = JSON.parse( this.simulation.post_param.replace("\n",'') );
                                }else if( 'object' === typeof this.simulation.post_param ){
                                    config.data = JSON.parse( JSON.stringify(this.simulation.post_param) );
                                }
                            } catch(e){ }
                        }
                    }
                    config.success = (json) => {
                        this.simulation.content = json;
                    }
                    config.error = () => {
                        this.simulation.content = '请求失败';
                    }
                    config.complete = (XMLHttpRequest, textStatus) => {
                        this.simulation.headers = XMLHttpRequest.getAllResponseHeaders();
                    }
                    this.simulation.request_url = config.type.toUpperCase() +" "+ config.url;
                    $.ajax(config);
                    // console.log( this.simulation.post_param , JSON.stringify(this.simulation) )
                },
                _timedTask() {
                    this.timed_task.show = this.timed_task.show === false;
                    TimedTask.getAll((err, database, conn) => {
                        this.timed_task.list = database;
                    })
                },
                _timedTaskReset() {
                    TimedTask.getAll((err, database, conn) => {
                        this.timed_task.list = database;
                        alert( '重新获取任务表 : 成功' )
                    })
                }
            },
            ready: function() {
                let trigger_count = 0;
                TimedTask.getAll((err, database, conn) => {
                    this.timed_task.list = database;
                    setInterval( () =>{
                        trigger_count ++;
                        if( trigger_count%5 === 4 ){
                            TimedTask.getAll((err, database, conn) => {
                                this.timed_task.list = database;
                                TimedTask.trigger();
                            });
                        }else{
                            TimedTask.trigger();
                        }
                    }, 50000 );
                })
            }
        });
    });
    </script>
</body>

</html>